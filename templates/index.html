<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Management</title>
    <style>
        :root {
            --primaryBlue-600: #063652;
            --primaryBlue-400: #3d6e8b;
            --primaryBlue-100: #cde6f8;
            --primaryBlue-50: #d9edff;
            --primaryBlack-900: #1a1a1a;
            --primaryBlack-0: #fff;
            --red-500: #b12020;
        }
        body { font-family: Inter, Arial, sans-serif; background: var(--primaryBlue-50); margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 40px auto; background: var(--primaryBlack-0); border-radius: 12px; box-shadow: 0 2px 16px #3d6e8b22; padding: 32px; }
        .row { margin-left: 0; margin-right: 0; }
        .card { margin-bottom: 24px; border-radius: 10px; }
        .card-header { border-radius: 10px 10px 0 0; font-weight: 600; font-size: 1.1rem; }
        .card-body { padding: 24px 20px 16px 20px; }
        @media (min-width: 992px) {
            .top-row-card { min-height: 180px; }
        }
        h1 { color: var(--primaryBlue-600); margin-bottom: 24px; }
        .section { margin-bottom: 32px; }
        .btn { background: var(--primaryBlue-600); color: #fff; padding: 10px 24px; border: none; border-radius: 6px; text-decoration: none; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        .btn:hover { background: var(--primaryBlue-400); }
        .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .form-row label { display: flex; flex-direction: column; font-weight: 500; color: var(--primaryBlue-600); }
        .form-row input { margin-top: 6px; padding: 8px 10px; border: 1px solid var(--primaryBlue-100); border-radius: 4px; font-size: 15px; }
        .info { color: var(--primaryBlue-600); }
        #backtest-table-container { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; background: var(--primaryBlack-0); }
        th, td { padding: 8px 12px; border: 1px solid var(--primaryBlue-100); text-align: center; }
        th { background: var(--primaryBlue-100); color: var(--primaryBlue-600); }
        tr:nth-child(even) { background: var(--primaryBlue-50); }
        #backtest-error { color: var(--red-500); margin-top: 10px; }
        tfoot td { font-weight: bold; background: var(--primaryBlue-100); }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1100px;">
        <h1 class="text-center" style="color: var(--primaryBlue-600); margin-bottom: 32px;">Portfolio Management</h1>


        <!-- Opportunity & Threat Insights -->
        <div class="section card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">Opportunities & Threats</div>
            <div class="card-body">
                <ul id="insights-list" style="margin:0; padding-left: 18px;"></ul>
            </div>
        </div>

        <!-- Machine Learning: Price Prediction (Linear Regression) -->
        <div class="section card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">ML Price Prediction (Next Day)</div>
            <div class="card-body">
                <form id="ml-predict-form" style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                    <label>Symbol
                        <input type="text" id="ml-symbol" value="HDFCBANK" style="width: 120px;">
                    </label>
                    <button type="submit" class="btn">Predict</button>
                </form>
                <div id="ml-predict-result" style="margin-top: 24px;"></div>
            </div>
        </div>

        <!-- Quant Backtest (Moving Average Crossover) -->
    // ML Prediction UI
    document.getElementById('ml-predict-form').onsubmit = function(e) {
        e.preventDefault();
        const symbol = document.getElementById('ml-symbol').value.trim();
        const resultDiv = document.getElementById('ml-predict-result');
        resultDiv.innerHTML = 'Predicting...';
        fetch('/api/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = `<span style='color:red;'>${data.error}</span>`;
                return;
            }
            resultDiv.innerHTML = `<b>Symbol:</b> ${data.symbol}<br><b>Last Close:</b> ₹${data.last_close.toFixed(2)}<br><b>Predicted Next Close:</b> <span style='color:blue;'>₹${data.predicted_next_close.toFixed(2)}</span>`;
        })
        .catch(() => {
            resultDiv.innerHTML = '<span style="color:red;">Failed to predict.</span>';
        });
    };
        <div class="section card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">Quant Backtest: Moving Average Crossover</div>
            <div class="card-body">
                <form id="quant-backtest-form" style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                    <label>Symbol
                        <input type="text" id="backtest-symbol" value="HDFCBANK" style="width: 120px;">
                    </label>
                    <label>Short Window
                        <input type="number" id="backtest-short" value="20" min="2" max="100" style="width: 80px;">
                    </label>
                    <label>Long Window
                        <input type="number" id="backtest-long" value="50" min="2" max="200" style="width: 80px;">
                    </label>
                    <button type="submit" class="btn">Run Backtest</button>
                </form>
                <div id="backtest-result" style="margin-top: 24px;"></div>
                <canvas id="backtest-chart" height="80" style="margin-top: 24px;"></canvas>
            </div>
        </div>

        <!-- Portfolio Risk, Performance, Forecast, Economic Metrics -->
        <div class="section card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">Portfolio Analytics</div>
            <div class="card-body">
                <div id="portfolio-metrics" style="display: flex; flex-wrap: wrap; gap: 32px; align-items: flex-end;"></div>
                <div id="economic-metrics" style="margin-top: 18px;"></div>
            </div>
        </div>

        <!-- Portfolio Charts -->
        <div class="section card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">Portfolio Charts</div>
            <div class="card-body">
                <canvas id="chart-performance" height="80"></canvas>
                <canvas id="chart-sector" height="60" style="margin-top: 32px;"></canvas>
            </div>
        </div>

        <form id="backtest-form">
            <!-- Portfolio Stocks List -->
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">Portfolio Stocks</div>
                <div class="card-body">
                    <table id="stocks-table">
                        <thead>
                            <tr>
                                <th>Stock Name</th>
                                <th>Symbol</th>
                                <th>Asset Class</th>
                                <th>Capitalization</th>
                                <th>Sector</th>
                                <th>P/E</th>
                                <th>Quantity</th>
                                <th>Buy Price</th>
                                <th>Total Investment</th>
                                <th>Weight %</th>
                                <th>Sector Weightage</th>
                                <th>Sector Weightage %</th>
                                <th>Asset Weightage</th>
                                <th>Asset Weightage %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="14">Loading...</td></tr>
                        </tbody>
                        <tfoot>
                            <tr id="totals-row">
                                <td colspan="6">Totals</td>
                                <td id="total-quantity"></td>
                                <td></td>
                                <td id="total-investment"></td>
                                <td>100%</td>
                                <td></td>
                                <td>100%</td>
                                <td></td>
                                <td>100%</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    function renderPortfolioMetrics(metrics) {
        const el = document.getElementById('portfolio-metrics');
        el.innerHTML = `
            <div><b>Portfolio Volatility:</b> ${(metrics.volatility * 100).toFixed(2)}%</div>
            <div><b>Avg Daily Return:</b> ${(metrics.avg_return * 100).toFixed(2)}%</div>
            <div><b>Sharpe Ratio:</b> ${metrics.sharpe.toFixed(2)}</div>
            <div><b>Max Drawdown:</b> ${(metrics.max_drawdown * 100).toFixed(2)}%</div>
            <div><b>Total Investment:</b> ₹${metrics.total_investment.toFixed(2)}</div>
        `;
    }

    function renderEconomicMetrics(econ) {
        const el = document.getElementById('economic-metrics');
        el.innerHTML = `
            <div style="display: flex; flex-wrap: wrap; gap: 32px;">
                <div><b>Nifty Index:</b> ${econ.nifty_index} (${econ.nifty_change_pct > 0 ? '+' : ''}${econ.nifty_change_pct}%)</div>
                <div><b>Inflation:</b> ${econ.inflation}%</div>
                <div><b>Interest Rate:</b> ${econ.interest_rate}%</div>
                <div><b>GDP Growth:</b> ${econ.gdp_growth}%</div>
            </div>
            <div style="margin-top: 8px;"><b>Sector Indices:</b> ${Object.entries(econ.sector_indices).map(([k,v]) => `${k}: ${v}`).join(', ')}</div>
        `;
    }

    function renderCharts(stocks) {
        // Performance chart (simulated historical prices)
        const ctxPerf = document.getElementById('chart-performance').getContext('2d');
        const labels = Array.from({length: 90}, (_, i) => `Day ${i+1}`);
        const datasets = stocks.map(stock => ({
            label: stock.name,
            data: stock.hist_prices,
            borderColor: '#' + Math.floor(Math.random()*16777215).toString(16),
            fill: false,
            tension: 0.1
        }));
        new Chart(ctxPerf, {
            type: 'line',
            data: { labels, datasets },
            options: { plugins: { legend: { display: true } }, responsive: true, scales: { y: { beginAtZero: false } } }
        });

        // Sector allocation chart (bar chart)
        const ctxSector = document.getElementById('chart-sector').getContext('2d');
        const sectorMap = {};
        stocks.forEach(s => { sectorMap[s.sector] = (sectorMap[s.sector] || 0) + s.total_investment; });
        new Chart(ctxSector, {
            type: 'bar',
            data: {
                labels: Object.keys(sectorMap),
                datasets: [{
                    label: 'Sector Allocation',
                    data: Object.values(sectorMap),
                    backgroundColor: Object.keys(sectorMap).map(() => '#' + Math.floor(Math.random()*16777215).toString(16)),
                }]
            },
            options: {
                plugins: { legend: { display: false } },
                responsive: true,
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Total Investment (₹)' } },
                    x: { title: { display: true, text: 'Sector' } }
                }
            }
        });
    }

    function renderInsights(insights) {
        const el = document.getElementById('insights-list');
        if (!insights || insights.length === 0) {
            el.innerHTML = '<li style="color: #888;">No actionable insights at this time.</li>';
            return;
        }
        el.innerHTML = '';
        insights.forEach(insight => {
            const li = document.createElement('li');
            li.textContent = insight.message;
            li.style.color = insight.type === 'opportunity' ? 'green' : (insight.type === 'threat' ? 'red' : '#333');
            el.appendChild(li);
        });
    }

    // Quant Backtest UI
    document.getElementById('quant-backtest-form').onsubmit = function(e) {
        e.preventDefault();
        const symbol = document.getElementById('backtest-symbol').value.trim();
        const short_window = parseInt(document.getElementById('backtest-short').value);
        const long_window = parseInt(document.getElementById('backtest-long').value);
        const resultDiv = document.getElementById('backtest-result');
        resultDiv.innerHTML = 'Running backtest...';
        fetch('/api/backtest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol, short_window, long_window })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                resultDiv.innerHTML = `<span style='color:red;'>${data.error}</span>`;
                return;
            }
            // Table of trades
            let html = `<b>Total Return:</b> ${(data.total_return*100).toFixed(2)}%<br><br>`;
            html += '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>Date</th><th>Price</th><th>Signal</th></tr></thead><tbody>';
            data.trades.forEach(trade => {
                html += `<tr><td>${trade.Date ? trade.Date.split('T')[0] : ''}</td><td>₹${trade.Close ? trade.Close.toFixed(2) : ''}</td><td>${trade.signal === 1 ? 'Buy' : (trade.signal === -1 ? 'Sell' : '')}</td></tr>`;
            });
            html += '</tbody></table>';
            resultDiv.innerHTML = html;
            // Chart
            const ctx = document.getElementById('backtest-chart').getContext('2d');
            if (window.backtestChart) window.backtestChart.destroy();
            const labels = data.history.map(row => row.Date ? row.Date.split('T')[0] : '');
            window.backtestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Close', data: data.history.map(r => r.Close), borderColor: '#063652', fill: false },
                        { label: 'SMA Short', data: data.history.map(r => r.SMA_short), borderColor: '#3d6e8b', fill: false },
                        { label: 'SMA Long', data: data.history.map(r => r.SMA_long), borderColor: '#b12020', fill: false }
                    ]
                },
                options: { plugins: { legend: { display: true } }, responsive: true, scales: { y: { beginAtZero: false } } }
            });
        })
        .catch(() => {
            resultDiv.innerHTML = '<span style="color:red;">Failed to run backtest.</span>';
        });
    };

    function fetchStocks() {
        fetch('/api/stocks')
            .then(res => res.json())
            .then(data => {
                const stocks = data.stocks;
                const metrics = data.portfolio_metrics;
                const econ = data.economic_metrics;
                const insights = data.insights;
                renderPortfolioMetrics(metrics);
                renderEconomicMetrics(econ);
                renderCharts(stocks);
                renderInsights(insights);
                // Table
                const tbody = document.querySelector('#stocks-table tbody');
                tbody.innerHTML = '';
                let totalInvestment = 0;
                let totalQuantity = 0;
                stocks.forEach(stock => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${stock.name}</td>
                        <td>${stock.symbol}</td>
                        <td>${stock.asset_class}</td>
                        <td>${stock.capitalization}</td>
                        <td>${stock.sector}</td>
                        <td>${stock.pe !== null && stock.pe !== undefined ? stock.pe : 'N/A'}</td>
                        <td>${stock.quantity !== null && stock.quantity !== undefined ? stock.quantity : 'N/A'}</td>
                        <td>${stock.buy_price !== null && stock.buy_price !== undefined ? '₹' + stock.buy_price.toFixed(2) : 'N/A'}</td>
                        <td>${stock.total_investment !== null && stock.total_investment !== undefined ? '₹' + stock.total_investment.toFixed(2) : 'N/A'}</td>
                        <td>${stock.weight_pct !== null && stock.weight_pct !== undefined ? stock.weight_pct.toFixed(2) + '%' : 'N/A'}</td>
                        <td>${stock.sector_weightage !== null && stock.sector_weightage !== undefined ? '₹' + stock.sector_weightage.toFixed(2) : 'N/A'}</td>
                        <td>${stock.sector_weightage_pct !== null && stock.sector_weightage_pct !== undefined ? stock.sector_weightage_pct.toFixed(2) + '%' : 'N/A'}</td>
                        <td>${stock.asset_weightage !== null && stock.asset_weightage !== undefined ? '₹' + stock.asset_weightage.toFixed(2) : 'N/A'}</td>
                        <td>${stock.asset_weightage_pct !== null && stock.asset_weightage_pct !== undefined ? stock.asset_weightage_pct.toFixed(2) + '%' : 'N/A'}</td>
                    `;
                    tbody.appendChild(tr);
                    totalInvestment += stock.total_investment || 0;
                    totalQuantity += stock.quantity || 0;
                });
                document.getElementById('total-investment').textContent = '₹' + totalInvestment.toFixed(2);
                document.getElementById('total-quantity').textContent = totalQuantity;
            })
            .catch(() => {
                const tbody = document.querySelector('#stocks-table tbody');
                tbody.innerHTML = '<tr><td colspan="14">Failed to load data</td></tr>';
            });
    }
    fetchStocks();
    </script>
</body>
</html>
